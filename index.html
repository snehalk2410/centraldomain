<!DOCTYPE html>
<html>
<head>
<title>W3.CSS Template</title>
<meta charset="UTF-8">
<script type="text/javascript">
     function generateUserID() {
            console.log(" centraldomain generateUserID ");
            try {
                let randomPart = crypto.randomUUID();
                var timestampPart = Math.floor(Date.now() / 1000).toString(16); // Current timestamp in seconds (to ensure uniqueness)
                return randomPart + '.' + timestampPart; // Combine random part and timestamp for a unique ID  
            } catch (error) {
                console.log("Error : ", error);
            }
        }
        function setPersistentCookie(name, value, days = 365) {
            try {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000)); // Calculate the expiration date
                const expires = "expires=" + date.toUTCString(); // Convert to UTC string format
                const secure = window.location.protocol === 'https:' ? "Secure" : ""; // Only secure if HTTPS
                const sameSite = "SameSite=Lax"; // Allow cross-origin requests to a certain extent -- Lax
                const domain = window.location.hostname.split('.').slice(-2).join('.'); // Get root domain     // "domain=.vercel.app"; // Set the highest-level domain
                console.log(" centraldomain highest-level domain ", domain);
                //  const cookieString = `${name}=${value}; ${expires}; path=/; ${secure}; ${sameSite}`;
                //  console.log("Setting cookie: ", cookieString);
                //  document.cookie = cookieString;
                document.cookie = name + "=" + value + ";" + expires + ";path=/;" + secure + ";" + sameSite;
 
                console.log("centraldomain document.cookie ", document.cookie);
            } catch (error) {
                console.log("Error : ", error);
            }
        }
        // Function to get a cookie by name
function getCookie(name) {
  try {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const [key, value] = cookie.split('=');
      if (key.trim() === name.trim()) {
        return decodeURIComponent(value);
        // return value;
      }
    }
    return null; // Return null if the cookie is not found
  } catch (error) {
    console.log("Error : ", error);
  }
}
        let userID = getCookie('userID');
         console.log(" centraldomain userID ", userID)
  if (!userID) {
    // If no userID exists in the cookies, generate a new one
    userID = generateUserID();
       console.log(" centraldomain userID 1", userID)
    setPersistentCookie('userID', userID, 365); // Set userID as a persistent cookie for 365 days
  }

     // --- Code to run INSIDE the iframe (on https://testinovation-cdp.vercel.app/) ---
 
// Helper function to get a specific cookie by name from THIS iframe's domain
function getCookieval(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  // Return undefined if cookie not found
  return undefined;
}


     document.addEventListener('DOMContentLoaded', function () {
    try {
         debugger;
// The specific name of the cookie to read from THIS domain ('testinovation-cdp.vercel.app')
const thirdPartyCookieName = 'userID';
 
// The origin of the PARENT window (YOUR HOST DOMAIN) that is allowed to receive the message.
// Use the specific origin provided by the user.
const parentOrigin = 'https://development-site-three.vercel.app'; 
 
console.log(`[IFRAME] Page loaded. Cookie to find: '${thirdPartyCookieName}'. Target parent origin: '${parentOrigin}'`);
 
// Attempt to read the cookie and send it when the iframe content is loaded
window.addEventListener('load', () => {
  console.log('[IFRAME] Window load event fired.');
 debugger;
  // Read the 'userID' cookie from this domain
  const cookieValue = getCookieval(thirdPartyCookieName);
  const cookieValue1 = getCookie('userID');
     console.log(" cookieValue1 ", cookieValue1)
 
  // Check if the cookie was found
  if (cookieValue !== undefined) {
    console.log(`[IFRAME] Found cookie '${thirdPartyCookieName}'. Value: '${cookieValue}'. Sending to parent.`);
 
    // Send the cookie value to the specific parent origin
    parent.postMessage({
      type: 'thirdPartyCookieData', // Identifier for the parent listener
      cookieName: thirdPartyCookieName, // Let parent know which cookie it was
      value: cookieValue
    }, parentOrigin); // SECURITY: Target the specific parent origin
 
  } else {
    console.log(`[IFRAME] Cookie '${thirdPartyCookieName}' was not found on this domain.`);
 
    // Optionally, inform the parent that the cookie wasn't found
    parent.postMessage({
      type: 'thirdPartyCookieNotFound',
      cookieName: thirdPartyCookieName
    }, parentOrigin);
  }
});
 
// Add error handling for postMessage if parentOrigin is invalid or other issues occur
try {
    console.log('[IFRAME] Script execution finished setup.');
} catch (e) {
    console.error('[IFRAME] Error during script setup or initial execution:', e);
}
    });

</script>
</head>
 
<body>
</body>
 
</html>
